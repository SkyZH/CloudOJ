# **关于你在使用 SNGOJ 时的种种怨念**

欢迎您使用 SNGOJ！

SNGOJ 是由 CloudOJ 为基础构建的在线评测平台。SNGOJ 的试题由师生共同维护。

如果您在使用中碰到任何问题，请不要迟疑直接点击页面底部的 Feedback 进行反馈。谢谢！

## 用户须知

-----------

请不要恶意卡评测机，吃服务器资源。

请不要恶意卡评测机，吃服务器资源。

请不要恶意卡评测机，吃服务器资源。

重要的事情重复三遍，希望大家使用 SNGOJ 提升自我。

### 改头像

头像使用 Gravatar 服务。因此你需要科学上网 www



## 给写题目的人的话

----------

SNGOJ 的题目编写并不是非常成熟。编写题目需要以下几个步骤：

1. 创建试题
2. 完善数据
3. 设置权限

### 创建试题

--------

成为管理员后重新登录，点击 Problems 页面右上角的 Create 按钮即可创建试题。

创建试题页面中需要填写 标题、内存限制、时间限制、分类、描述、输入描述、输出描述、提示 的信息。

#### 标题格式

标题由三部分组成。


比赛/来源 `[SNG Camp 2015 - Junior]`

题目名称 `Book - 帕奇的书架`

标签 `(Modified)`  `(No Data)`

所以题目可以有以下几种形式：

* `A+B Problem`
* `[Summer Camp 2015 - Junior] Book - 帕奇的书架`
* `[NOIP 2014] Equation (Modified)`
* `Prime (No Data)`

后期我们将增加题目的分类、来源系统。

#### 题目编辑

题目全部使用 Markdown 语法编写。如果您第一次使用 Markdown，请注意以下几点：

1. 换行 在需要换行的行末打 4 个以上的空格，或者添加一个空行。

2. 粗体、斜体、标题、分割线 **粗体** `**我是粗体**` _斜体_ `_我是斜体_`  标题 `### 23333` (1 ~ 6 个 `#`) 分割线 `-------`

题目中还可以出现数学公式。我们支持 Latex 数学公式。

数学公式使用 `\\( \\)` 或者 `$ $` 括起来。

* $ a \times b $ `$ a \times b $`

* \\( a \le b \\) `\\( a \le b \\)`

由于试题的解析顺序是先转换 Markdown 再解析 Latex，所以如果您的公式中有下划线等字符，请加 `\` 转义。

* $ a\_i $ `a\_i`

同时编辑器也支持 Emoji 表情。直接在编辑器中输入 Emoji 表情后，我们就会自动转换成图片。

#### 一些注意事项

* 请在中西文间增加空格

以下是正确示范：

* 欢迎来到 SNGOJ `欢迎来到 SNGOJ`

* 数据范围是 $ 1 \le n \le 100$ `数据范围是 $ 1 \le n \le 100$`

* [2015 Summer Camp - Junior] `[2015 Summer Camp - Junior]`

* Hello, World `Hello, World`

然而以下的文本是坚决不允许的：

* 欢迎来到SNGOJ `欢迎来到SNGOJ`

* 数据范围是$ 1 \le n \le 100$ `数据范围是$ 1 \le n \le 100$`

* [2015 Summer Camp-Junior] `[2015 Summer Camp-Junior]`

* Hello,World `Hello,World`

请记得在题目说明每行最后添加一个句号：

* 今天阳光明媚，万里无云。数据范围是 $ 1 \le n \le 100$。

然而以下的句子是坚决不允许的：

* 今天阳光明媚，万里无云。数据范围是 $ 1 \le n \le 100$

### 编辑数据

--------

#### 创建数据

数据在 Data 选项卡内创建。

数据选择 `TestData` 模式，则不会显示。选择 `Sample` 模式，则会显示在问题查看页面中。但目前所有数据都会参与评测。

数据选择 `Plain Text`，则直接读取文本框的内容；选择 `Path`，则会在 `/htdocs/oj/ojdata/` 目录里查询文件并发送给评测机。

数据中不得出现除英文、数字、符号以外的字符，否则评测机无法正确处理字符并储存导致崩溃。

当你更改数据后（包括更改文件模式下的文件名，文件内容），请务必修改数据的名称。评测机会根据名称和数据编号进行缓存，因此你必须修改名称来强制刷新缓存。

#### 扫描数据

通过 Scan 按钮，服务器会自动扫描 `htdocs/oj/ojdata/{pid}/` 下的文件，并添加到当前问题数据中。

#### 数据名称

为了简单快捷地使用 `StringStrip` 过滤字符，防止储存数据文件时引来不必要的崩溃，所以数据名称只能出现字母和数字。

当然如果扫描的文件名内含有字母数字以外的字符，我们不会过滤。

#### 数据格式

数据内只能含有字母、数字、符号，尽量不要出现可能与 MathJax 冲突的字符，比如 `$` `\(` `\)`。

数据的换行符随意，将数据送到评测机的过程中 PHP 程序会自动去除所有 `\r` 保留 `\n`

请注意：

Input

    1 2

Output

    3

以及

Input

    1
    2

Output

    3

对于 Python 程序来说，并不相同。希望出题者可以注意输入中的换行。

#### 评测机评测方法

首先使用 Python 的 subprocess 模块编译程序。

接着使用 Lo-runner 运行程序。

Lo-runner 运行程序的过程中，如果出现 CE, MLE, TLE, RE 等程序运行时错误，不会返回占用内存、时间信息。

当评测机程序检测到 Lo-runner 顺利执行完程序后，会调用 Lo-runner 的 check 函数进行比较。

Lo-runner 首先确认输出大小，太大返回 OLE。

接着逐字节比较文件，完全相同返回 Accepted。

如果不完全相同，去除换行符、空格、制表符再比较一次，如果答案和用户输出相同，返回 Presentation Error。

如果以上过程中发现答案的确不同，返回 Wrong Answer。

#### 评测机运行流程

评测机使用约定好的 WatcherAPIKey 与服务器的 /oj/watcherapi 使用 HTTP 协议通信。

评测机使用 Verify 操作验证密钥，开始执行命令。每一秒向服务器查询可用任务。

查询到任务后下载程序，并刷新题目数据。题目数据很大时，评测可能会卡在 Running 状态而 Details 里没有新数据生成。

评测机每执行一步就向 Watcher API 发送数据更新数据库。

## 给开发者们的话

-----------------------

### Watcher API

评测机使用约定好的 WatcherAPIKey 与服务器的 /oj/watcherapi 使用 HTTP 协议通信。

与 Watcher API 相关的函数都封装在 CloudOJWatcher 的 oj.py 内。当然 ojjudger.py 再一次封装了这些函数以便评测时方便调用。

通信的方式有纯文本和 JSON 两种。

PHP 服务器错误时，都会以 JSON 格式返回 `{status: "error", detail: "..."}`。

PHP 服务器成功处理请求，如果返回 JSON 格式，必有 `{status: "success"}`。

每一个请求都必须使用 POST 发出。除了 `Verify` 外，其他请求一律在 URL 中以 Query 形式附上 APIKey。

* oj.Verify

  检测 WatcherAPIKey 是否匹配。

* oj.GetTask

  向服务器请求接受任务，返回任务 id，题目 id，编译语言。

* oj.GetCode(`任务 id`)

  请求该任务所对应的代码。

* oj.GetData(`数据 id`, `类型`)

  请求数据。

* oj.GetDataList(`题目 id`)

  返回题目的数据列表。

* oj.PutRet(`任务 id`, `返回数据`):

  设置评测机的返回数据，显示在 Detail 中。

* oj.PutStatus(`任务 id`, `状态编号`, `占用内存`, `使用时间`)

  更新任务的摘要信息。如果出现运行时错误，编译不过，占用内存与时间均为零。


由于 CloudOJ 依然处于测试版本，各项功能仍然不够完善，评测机的 WatcherAPI 可能会不断变化。
